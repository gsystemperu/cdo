var tipdoc="";Ext.define("MyDesktop.app.views.FacturaBoleta",{extend:"Ext.window.Window",alias:"widget.facturaboleta",id:"wfacturaboleta",width:450,height:480,modal:true,autoShow:true,bodyPadding:"5 5 5 5",title:"Entrega y Cobro del Contrato",initComponent:function(){me=this;me.setTotalesDeContrato();Ext.apply(me,{layout:"fit",items:[{xtype:"panel",frame:true,items:[{xtype:"fieldset",title:"Selecionar el tipo de documento",items:[{xtype:"radiogroup",fieldLabel:"Tipo",id:"grupodocumento",columns:2,vertical:false,items:[{boxLabel:"Boleta",name:"rb",inputValue:"B"},{boxLabel:"Factura",name:"rb",inputValue:"F"},{boxLabel:"Contrato",name:"rb",inputValue:"C",checked:true}],listeners:{change:function(c,b,a){tipdoc=b.rb;switch(b.rb){case"F":Ext.getCmp("txtNumeroFactura").setDisabled(false).focus();Ext.getCmp("txtCliente").setDisabled(false);Ext.getCmp("txtRuc").setDisabled(false);break;case"B":Ext.getCmp("txtNumeroFactura").setDisabled(false).setValue("").focus();Ext.getCmp("txtCliente").setDisabled(true).setValue("");Ext.getCmp("txtRuc").setDisabled(true).setValue("");break;default:Ext.getCmp("txtNumeroFactura").setDisabled(true).setValue("");Ext.getCmp("txtCliente").setDisabled(true).setValue("");Ext.getCmp("txtRuc").setDisabled(true).setValue("")}}}}]},{xtype:"fieldset",title:"Resumen del Contrato",layout:"vbox",items:[{xtype:"hiddenfield",id:"txtIdContrato"},{xtype:"textfield",id:"txtNumeroFactura",fieldLabel:"Numero Doc",fieldStyle:"text-align: right;",disabled:true},{xtype:"textfield",id:"txtCliente",fieldLabel:"Cliente",fieldStyle:"text-align: left;",disabled:true,width:400},{xtype:"textfield",id:"txtRuc",fieldLabel:"Ruc",fieldStyle:"text-align: right;",disabled:true},{xtype:"textfield",id:"txtDireccion",fieldLabel:"Direcci\xf3n",fieldStyle:"text-align: left;",disabled:true,width:400},{xtype:"textfield",id:"txtMonto",fieldLabel:"Monto",fieldStyle:"text-align: right;",readOnly:true},{xtype:"textfield",fieldLabel:"Igv",id:"txtIgv",fieldStyle:"text-align: right;",readOnly:true},{xtype:"textfield",fieldLabel:"Total",id:"txtTotal",fieldStyle:"text-align: right;",readOnly:true}]},{xtype:"fieldset",title:"Resumen de Pago a cuenta",layout:"vbox",items:[{xtype:"textfield",id:"txtPagoAcuenta",fieldLabel:"Monto",fieldStyle:"text-align: right;",readOnly:true}]},{xtype:"container",items:[{xtype:"checkbox",fieldLabel:"<b>* CANCELO TODO EL SALDO</b>",id:"ckbCancelaSaldo",labelWidth:220}]},{xtype:"button",text:"<b>GUARDAR ENTREGA</b>",scale:"large",handler:function(){me.setGuardarVenta()}}]}]});this.callParent(arguments)},setTotalesDeContrato:function(){Ext.Ajax.request({url:"contratos/listartotalescontrato",params:{idcontra:this.getIdContrato()},success:function(e,b,c,d){var a=MyDesktop.app.util.Util.decodeJSON(e.responseText);if(a.success){Ext.each(a.items,function(f){Ext.getCmp("txtIdContrato").setValue(f.idcontrato);Ext.getCmp("txtMonto").setValue(f.monto);Ext.getCmp("txtIgv").setValue(f.igv);Ext.getCmp("txtTotal").setValue(f.total);Ext.getCmp("txtPagoAcuenta").setValue((f.pagacuenta==null?0:f.pagacuenta))})}else{MyDesktop.app.util.Util.showErrorMsg(e.responseText);return false}},failure:function(d,a,b,c){}})},setGuardarVenta:function(){var b=Ext.getCmp("grupodocumento").getValue();var e=Ext.getCmp("ckbCancelaSaldo").getValue();var a=Ext.getCmp("txtNumeroFactura").getValue();var f=Ext.getCmp("txtIdContrato").getValue();var c=Ext.getCmp("txtCliente").getValue();var d=Ext.getCmp("txtRuc").getValue();Ext.Ajax.request({url:"contratos/actualizardocumentoventa",params:{piddocventa:0,pidcontrato:f,ptipodoc:b.rb,psw:(e==true?1:0),pusuario:"EERAZO",pnumerodoc:a},success:function(k,h,i,j){var g=MyDesktop.app.util.Util.decodeJSON(k.responseText);if(g.success){Ext.each(g.items,function(l){if(l.ERROR>0){if(tipdoc=="F"){me.setActualizarCliente(f,c,d)}else{Ext.getCmp("dgvContratos").getStore().reload();Ext.getCmp("wfacturaboleta").close();me.setImprimirDocumentoVenta(parseInt(f))}}})}else{MyDesktop.app.util.Util.showErrorMsg(k.responseText);return false}},failure:function(j,g,h,i){}})},setActualizarCliente:function(b,a,c){me=this;Ext.Ajax.request({url:"contratos/clienteactualizar",params:{pidcontrato:b,pnombres:a,pnumruc:c},success:function(h,e,f,g){var d=MyDesktop.app.util.Util.decodeJSON(h.responseText);if(d.success){Ext.each(d.items,function(i){if(i.ERROR>0){me.setImprimirDocumentoVenta(parseInt(b));Ext.getCmp("dgvContratos").getStore().reload();Ext.getCmp("wfacturaboleta").close()}})}}})},getIdContrato:function(){var b=Ext.getCmp("dgvContratos");var a=b.getSelectionModel().getSelection()[0];return a.get("idcontrato")},setImprimirDocumentoVenta:function(b){var a="reportes/imprimirdocumentoventa/"+parseInt(b).toString();xpos=(screen.width/2)-(1000/2);ypos=(screen.height/2)-(600/2);my=window.open(a,"mywindow","location=1,status=1,scrollbars=1,  width=1000,height=600");my.moveTo(xpos,ypos);setTimeout(function(){my.close()},1000)}});