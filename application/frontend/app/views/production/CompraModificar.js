ix=0;ult_id=0;Ext.define("MyDesktop.app.views.CompraModificar",{extend:"Ext.window.Window",alias:"widget.compramodificar",width:680,height:600,modal:true,title:"Modificar Compra",autoShow:true,requires:["MyDesktop.app.stores.Productos","MyDesktop.app.stores.Proveedores","MyDesktop.app.stores.Generos","MyDesktop.app.stores.Compras","MyDesktop.app.views.ProveedorEditar"],initComponent:function(){me=this;storemateriales=Ext.create("MyDesktop.app.stores.Materiales");storeproveedores=Ext.create("MyDesktop.app.stores.Proveedores");storetipomoneda=Ext.create("MyDesktop.app.stores.TipoMonedas");storetipodoc=Ext.create("MyDesktop.app.stores.TipoDoc");storedetallecompra=Ext.create("MyDesktop.app.stores.DetalleCompra");Ext.applyIf(this,{items:[{xtype:"form",id:"frmcompramodificar",flex:1,frame:true,border:false,items:[{xtype:"hiddenfield",name:"id",id:"txtIdCompra"},{xtype:"fieldset",title:"Datos del Proveedor",defaultType:"textfield",layout:"fit",items:[{xtype:"container",layout:"hbox",margin:"0 0 5 6",items:[{xtype:"combobox",id:"cboProveedor",store:storeproveedores,query:"remote",name:"_idprov",valueField:"_idprov",displayField:"_completo",flex:1,editable:false,triggerAction:"all",emptyText:"--- Seleccionar el Proveedor ---"}]}]},{xtype:"fieldset",columnWidth:0.1,title:"Datos Generales ",items:[{xtype:"container",layout:"hbox",columnWidth:0.5,margin:"0 0 5 6",items:[{xtype:"combo",fieldLabel:"Tipo",id:"cboTipoDoc",store:storetipodoc,query:"local",name:"tipdoc",valueField:"id",displayField:"descripcion",width:200,labelWidth:50,value:"F",editable:false,listeners:{select:function(c,a,b){me.getCalcularContrato(Ext.getCmp("dgvDetalleCompra").getStore())}}},{xtype:"datefield",name:"fecha",flex:1,fieldLabel:"Fecha",name:"dfCompra",id:"dfCompra",minValue:new Date(),value:new Date(),labelWidth:80},{xtype:"textfield",flex:1,fieldLabel:"Nro.Documento",fieldStyle:"text-align: right;",id:"txtNumeroDocumento",labelWidth:120,name:"numerodocumento"}]}]},{xtype:"fieldset",columnWidth:0.1,title:"Detalle",defaultType:"textfield",items:[{xtype:"container",layout:"fit",frame:true,border:false,items:[{xtype:"container",layout:"vbox",margin:"0 0 10 6",items:[{xtype:"combobox",fieldLabel:"Producto",id:"cboProducto",store:storemateriales,query:"local",valueField:"id",displayField:"descrip",flex:1,width:600,editable:false,forceSelection:true,emptyText:"--- Seleccionar el Producto ---",listeners:{select:function(c,a,b){Ext.getCmp("txtPreciocompra").focus(false,200);Ext.getCmp("txtPreciocompra").setValue("");Ext.getCmp("txtCantidad").setValue(1);Ext.getCmp("txtCodigoBobina").setValue("");Ext.getCmp("txtMetroLineal").setValue("")}}},{xtype:"container",layout:"vbox",flex:1,items:[{xtype:"container",layout:"hbox",border:false,padding:"0 0 5 0",items:[{xtype:"numberfield",id:"txtPreciocompra",mane:"preciocompra",fieldLabel:"Precio Compra",fieldStyle:"text-align:right",decimalPrecision:2,step:0.01,decimalSeparator:"."},{xtype:"textfield",fieldLabel:"Codigo Bobina",id:"txtCodigoBobina",width:220,enableKeyEvents:true,listeners:{keyup:function(a,b){if(this.getValue().length!=0){Ext.getCmp("txtMetroLineal").setDisabled(false)}else{Ext.getCmp("txtMetroLineal").setDisabled(true)}}}}]},{xtype:"container",layout:"hbox",border:false,padding:"0 0 5 0",items:[{xtype:"numberfield",fieldLabel:"Cantidad",id:"txtCantidad",fieldStyle:"text-align:center;size:15px",maxValue:50,minValue:0,flex:0.5,value:1,editable:false,readOnly:true},{xtype:"numberfield",fieldLabel:"Metro Lineal",id:"txtMetroLineal",value:0,fieldStyle:"text-align:center;size:15px",minValue:0,flex:0.5,readOnly:false,width:220,disabled:true}]}]}]}]},{xtype:"panel",layout:"fit",margin:"0 0 5 0",items:[{xtype:"grid",flex:1,id:"dgvDetalleCompra",store:storedetallecompra,columns:[{text:"Id",dataIndex:"id",align:"center",width:25,hidden:true},{text:"Producto",dataIndex:"producto",width:250},{text:"Bobina",dataIndex:"codbobina",align:"right",width:80,hidden:false},{text:"M.Lineal",dataIndex:"mlineal",align:"right",width:60,hidden:false},{text:"Precio",dataIndex:"precio",width:55,align:"center"},{text:"Cantidad",dataIndex:"cantidad",width:55,align:"center"},{text:"Total",dataIndex:"total",align:"right",width:60},{xtype:"actioncolumn",width:40,align:"center",items:[{iconCls:"remove",handler:function(e,f,d){var b=e.getStore().getAt(f);var a=b.get("id");var c=Ext.getCmp("dgvDetalleCompra").getStore();c.remove(c.findRecord("id",a));me.getCalcularContrato(c)}}]}],height:150,listeners:{itemdblclick:function(d,b,f,c,g){var a=b.get("idprod");Ext.getCmp("cboProducto").setValue(a.toString());Ext.getCmp("txtPreciocompra").setValue(b.get("total")/b.get("cantidad"));Ext.getCmp("txtCantidad").setValue(b.get("cantidad"));Ext.getCmp("txtCodigoBobina").setValue(b.get("codbobina"));var h=b.get("mlineal");if(parseInt(h)>0){Ext.getCmp("txtMetroLineal").setDisabled(false);Ext.getCmp("txtMetroLineal").setValue(b.get("mlineal"))}else{Ext.getCmp("txtMetroLineal").setDisabled(true);Ext.getCmp("txtMetroLineal").setValue(b.get("mlineal"))}Ext.getCmp("txtPreciocompra").focus()}}}],tbar:[{xtype:"button",text:"Ingresar",id:"btnIngresar",iconCls:"add",handler:function(){me.setInsertarItem()}},{xtype:"button",text:"Modificar",id:"btnModificar",iconCls:"boton-edit",handler:function(){var f=Ext.getCmp("dgvDetalleCompra");var b=f.getSelectionModel().getSelection()[0].get("id");var e=Ext.getCmp("dgvDetalleCompra").getStore();var d=e.findRecord("id",b);if(d){var h=Ext.getCmp("txtPreciocompra").getValue();var c=Ext.getCmp("txtCantidad").getValue();var a=Ext.getCmp("txtCodigoBobina").getValue();var g=h*c;d.set("precio",g);d.set("cantidad",c);d.set("total",g);d.set("codbobina",a);d.endEdit();d.commit();me.getCalcularContrato(e)}}}]}]},{xtype:"panel",border:false,layout:"hbox",items:[{xtype:"panel",border:false,frame:true,flex:1,padding:"5 0 0 320",items:[{xtype:"numberfield",id:"txtSubtotal",name:"subtotal",fieldLabel:"Sub Total",decimalPrecision:3,minValue:0,step:0.01,decimalSeparator:".",readOnly:true,fieldStyle:"text-align: right;"},{xtype:"numberfield",fieldLabel:"Igv",id:"txtIgv",name:"igv",fieldStyle:"text-align: right;",decimalPrecision:3,minValue:0,step:0.01,decimalSeparator:".",readOnly:true,enableKeyEvents:true},{xtype:"numberfield",fieldLabel:"Total ",id:"txtTotal",name:"total",decimalPrecision:3,minValue:0,step:0.01,decimalSeparator:".",readOnly:true,fieldStyle:"text-align: right;"}]}]},{xtype:"panel",border:false,frame:false,buttons:[{xytpe:"button",text:"Cancelar",scale:"medium",iconCls:"boton-cancel ",handler:function(){ix=0;me.close()}},"-",{xytpe:"button",text:"Modificar",scale:"medium",iconCls:"boton-save ",handler:function(){me.modificarCompra(storedetallecompra);me.close()}}]}]}]});this.callParent(arguments)},getCalcularContrato:function(b){var e=Ext.getCmp("cboTipoDoc").getValue();var c=0;var f=0;var a=0;b.each(function(g){a=a+g.get("total")},this);if(e=="F"){c=a+(a*0.18);f=(a*0.18)}else{c=a}Ext.getCmp("txtSubtotal").setValue(a.toFixed(3));Ext.getCmp("txtIgv").setValue(f.toFixed(3));var d=(c+f);Ext.getCmp("txtTotal").setValue(d.toFixed(3))},setInsertarItem:function(){store=Ext.getCmp("dgvDetalleCompra").getStore();var b=Ext.getCmp("cboProducto").getValue();var f=Ext.getCmp("cboProducto").getStore().find("id",b);var a=Ext.getCmp("cboProducto").getStore().getAt(f).get("descrip");var c=Ext.getCmp("txtCantidad").getValue();var e=Ext.getCmp("txtPreciocompra").getValue();var g=Ext.getCmp("txtCodigoBobina").getValue();var d=Ext.getCmp("txtMetroLineal").getValue();ix=ix+1;store.add({id:ix,idprod:parseInt(b),producto:a,precio:e,cantidad:c,total:(e*c),codbobina:(g.length==0?"0":g),mlineal:d});store.sync();this.getCalcularCompra()},getCalcularCompra:function(){var b=Ext.getCmp("dgvDetalleCompra").getStore();var e=Ext.getCmp("cboTipoDoc").getValue();var c=0;var f=0;var a=0;b.each(function(g){a=a+g.get("total")},this);if(e=="F"){c=a+(a*0.18);f=(a*0.18)}else{c=a}Ext.getCmp("txtSubtotal").setValue(a.toFixed(3));Ext.getCmp("txtIgv").setValue(f.toFixed(3));var d=(c+f);Ext.getCmp("txtTotal").setValue(d.toFixed(3))},setCargarDatosDeCompra:function(a){Ext.Ajax.request({url:"compras/detalledecompra",params:{pidcompra:a},success:function(h,d,e,f){var b=MyDesktop.app.util.Util.decodeJSON(h.responseText);var c=Ext.getCmp("dgvDetalleCompra").getStore();var g=new Ext.LoadMask(Ext.getCmp("dgvDetalleCompra"),{msg:" Buscando la informacion..."});g.show();Ext.each(b.items,function(i){c.add({id:ix,idprod:parseInt(i.idproducto),producto:i.descripcion,precio:i.preprod,cantidad:i.cant,total:(i.preprod*i.cant),codbobina:(i.bobina.length==0?"0":i.bobina),mlineal:i.lineal});ix++});c.sync();g.destroy()}})},modificarCompra:function(b){me=this;var a=0;Ext.Ajax.request({url:"compras/actualizar",params:{pid:parseInt(Ext.getCmp("txtIdCompra").getValue()),pidprov:Ext.getCmp("cboProveedor").getValue(),pfcompra:Ext.getCmp("dfCompra").getValue(),pnumerodoc:Ext.getCmp("txtNumeroDocumento").getValue(),pvalorcompra:Ext.getCmp("txtSubtotal").getValue(),pvalorigv:Ext.getCmp("txtIgv").getValue(),pvalortotal:Ext.getCmp("txtTotal").getValue(),ptipodoc:Ext.getCmp("cboTipoDoc").getValue(),pusuario:"EERAZO"},success:function(g,d,e,f){var c=MyDesktop.app.util.Util.decodeJSON(g.responseText);if(c.success){Ext.each(c.items,function(h){if(h.ERROR<0){Ext.Msg.alert("Error","Error en Sistema ! Comunicarse con Sistemas");return false}me.actualizarCompraDetalle(h.ERROR,b)})}else{MyDesktop.app.util.Util.showErrorMsg(g.responseText);return false}},failure:function(f,c,d,e){}})},actualizarCompraDetalle:function(b,e){me=this;var d="";var g="";var a="";var c="";var f="";var h="";e.each(function(j){d=d+","+j.get("idprod").toString();g=g+","+j.get("cantidad").toString();a=a+","+j.get("precio").toString();c=c+","+j.get("codbobina").toString();f=f+","+j.get("total").toString();try{h=h+","+j.get("mlineal").toString()}catch(i){h=h+","+j.get("mlineal")}});d="{"+d.substring(1,d.length)+"}";g="{"+g.substring(1,g.length)+"}";a="{"+a.substring(1,a.length)+"}";c="{"+c.substring(1,c.length)+"}";f="{"+f.substring(1,f.length)+"}";h="{"+h.substring(1,h.length)+"}";me.ContratoModificarDetalle(b,d,g,a,c,f,h,e)},ContratoModificarDetalle:function(b,e,g,a,d,f,h,c){Ext.Ajax.request({url:"compras/actualizardetalle",params:{pidcompra:b,pproductos:e,pcantidades:g,pcodbobinas:d,pprecios:a,pmlineales:h},success:function(m,j,k,l){var i=MyDesktop.app.util.Util.decodeJSON(m.responseText);if(i.success){Ext.each(i.items,function(n){if(n.ERROR>0){Ext.getCmp("btnActualizarListaCompra").fireEvent("click")}})}else{MyDesktop.app.util.Util.showErrorMsg(m.responseText);return false}},failure:function(l,i,j,k){}})}});