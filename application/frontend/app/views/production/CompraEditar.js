ix=0;ult_id=0;Ext.define("MyDesktop.app.views.CompraEditar",{extend:"Ext.window.Window",alias:"widget.wcompraeditar",id:"wcompraeditar",width:680,height:600,modal:true,floating:true,autoShow:true,title:"::: - Registro de Compras - :::",bodyPadding:5,requires:["MyDesktop.app.stores.Productos","MyDesktop.app.stores.Proveedores","MyDesktop.app.stores.Generos","MyDesktop.app.stores.Compras","MyDesktop.app.views.ProveedorEditar"],initComponent:function(){var a=0;var b=0;var c=this;storemateriales=Ext.create("MyDesktop.app.stores.Materiales");storeproveedores=Ext.create("MyDesktop.app.stores.Proveedores");storetipomoneda=Ext.create("MyDesktop.app.stores.TipoMonedas");storetipodoc=Ext.create("MyDesktop.app.stores.TipoDoc");storedetallecompra=Ext.create("MyDesktop.app.stores.DetalleCompra");Ext.applyIf(c,{items:[{xtype:"panel",flex:1,frame:true,border:false,items:[{xtype:"fieldset",title:"Datos del Proveedor",defaultType:"textfield",layout:"fit",items:[{xtype:"container",layout:"hbox",margin:"0 0 5 6",items:[{xtype:"combobox",id:"cboProveedor",store:storeproveedores,query:"local",valueField:"_idprov",displayField:"_completo",flex:1,editable:false,triggerAction:"all",forceSelection:true,emptyText:"--- Seleccionar el Proveedor ---"},{xtype:"button",iconCls:"add",id:"btnProveedorNuevo",handler:function(){var d=Ext.create("MyDesktop.app.views.ProveedorEditar")}}]}]},{xtype:"fieldset",columnWidth:0.1,title:"Datos Generales ",items:[{xtype:"container",layout:"hbox",columnWidth:0.2,margin:"0 0 5 6",items:[{xtype:"combo",fieldLabel:"Tipo",id:"cboTipoDoc",store:storetipodoc,query:"local",valueField:"id",displayField:"descripcion",width:200,labelWidth:50,editable:false,value:"F",listeners:{select:function(f,d,e){c.getCalcularContrato()}}},{xtype:"datefield",flex:1,fieldLabel:"Fecha",name:"dfCompra",id:"dfCompra",minValue:new Date(),value:new Date(),labelWidth:80},{xtype:"textfield",flex:1,fieldLabel:"Nro.Documento",fieldStyle:"text-align: right;",id:"txtNumeroDocumento",labelWidth:120}]}]},{xtype:"fieldset",columnWidth:0.1,title:"Detalle",defaultType:"textfield",items:[{xtype:"container",layout:"fit",frame:true,border:false,items:[{xtype:"container",layout:"vbox",margin:"0 0 10 6",items:[{xtype:"combobox",fieldLabel:"Producto",id:"cboProducto",store:storemateriales,query:"local",valueField:"id",displayField:"descrip",flex:1,width:475,editable:false,forceSelection:true,emptyText:"--- Seleccionar el Producto ---",listeners:{select:function(f,d,e){Ext.getCmp("txtPreciocompra").focus(false,200);Ext.getCmp("txtPreciocompra").setValue("");Ext.getCmp("txtCantidad").setValue(1)}}},{xtype:"container",layout:"vbox",flex:1,items:[{xtype:"container",layout:"hbox",border:false,padding:"0 0 5 0",items:[{xtype:"numberfield",id:"txtPreciocompra",mane:"preciocompra",fieldLabel:"Precio Compra",fieldStyle:"text-align:right",decimalPrecision:2,step:0.01,decimalSeparator:"."},{xtype:"textfield",fieldLabel:"Codigo Bobina",id:"txtCodigoBobina",width:220,enableKeyEvents:true,listeners:{keyup:function(d,f){if(this.getValue().length!=0){Ext.getCmp("txtMetroLineal").setDisabled(false)}else{Ext.getCmp("txtMetroLineal").setDisabled(true)}}}}]},{xtype:"container",layout:"hbox",border:false,padding:"0 0 5 0",items:[{xtype:"numberfield",fieldLabel:"Cantidad",id:"txtCantidad",fieldStyle:"text-align:center;size:15px",maxValue:50,minValue:0,flex:0.5,value:1,editable:false,readOnly:true},{xtype:"numberfield",fieldLabel:"Metro Lineal",id:"txtMetroLineal",value:0,fieldStyle:"text-align:center;size:15px",minValue:0,flex:0.5,readOnly:false,width:220,disabled:true}]}]}]}]},{xtype:"panel",layout:"fit",margin:"0 0 5 0",items:[{xtype:"grid",flex:1,id:"dgvDetalleCompra",store:storedetallecompra,columns:[{text:"Id",dataIndex:"id",align:"center",width:25,hidden:true},{text:"Producto",dataIndex:"producto",width:250},{text:"Bobina",dataIndex:"codbobina",align:"right",width:80,hidden:false},{text:"M.Lineal",dataIndex:"mlineal",align:"right",width:60,hidden:false},{text:"Precio",dataIndex:"precio",width:55,align:"center"},{text:"Cantidad",dataIndex:"cantidad",width:55,align:"center"},{text:"Total",dataIndex:"total",align:"right",width:60},{xtype:"actioncolumn",width:40,align:"center",items:[{iconCls:"remove",handler:function(h,i,g){var e=h.getStore().getAt(i);var d=e.get("id");var f=Ext.getCmp("dgvDetalleCompra").getStore();f.remove(f.findRecord("id",d));c.getCalcularContrato()}}]}],height:150,listeners:{itemdblclick:function(h,f,i,g,j){var d=f.get("idprod");Ext.getCmp("cboProducto").setValue(d.toString());Ext.getCmp("txtPreciocompra").setValue(f.get("total")/f.get("cantidad"));Ext.getCmp("txtCantidad").setValue(f.get("cantidad"));Ext.getCmp("txtCodigoBobina").setValue(f.get("codbobina"));Ext.getCmp("txtMetroLineal").setValue(f.get("mlineal"))}}}],tbar:[{xtype:"button",text:"Ingresar",id:"btnIngresar",iconCls:"add",handler:function(){c.setInsertarItem(storedetallecompra)}},{xtype:"button",text:"Modificar",id:"btnModificar",iconCls:"boton-edit",handler:function(){var d=Ext.getCmp("dgvDetalleCompra");var i=d.getSelectionModel().getSelection()[0].get("id");var j=Ext.getCmp("dgvDetalleCompra").getStore();var g=j.findRecord("id",i);if(g){var e=Ext.getCmp("txtPreciocompra").getValue();var l=Ext.getCmp("txtCantidad").getValue();var f=Ext.getCmp("txtCodigoBobina").getValue();var k=Ext.getCmp("txtMetroLineal").getValue();var h=e*l;g.set("precio",h);g.set("cantidad",l);g.set("total",h);g.set("codbobina",f);g.set("mlineal",k);g.endEdit();g.commit();c.getCalcularContrato();c.getLimpiarPanel()}}}]}]},{xtype:"panel",border:false,layout:"hbox",items:[{xtype:"panel",border:false,frame:true,flex:1,padding:"5 0 0 320",items:[{xtype:"numberfield",id:"txtSubtotal",name:"subtotal",fieldLabel:"Sub Total",decimalPrecision:3,minValue:0,step:0.01,decimalSeparator:".",readOnly:true,fieldStyle:"text-align: right;"},{xtype:"numberfield",fieldLabel:"Igv",id:"txtIgv",name:"igv",fieldStyle:"text-align: right;",decimalPrecision:3,minValue:0,step:0.01,decimalSeparator:".",readOnly:true,enableKeyEvents:true},{xtype:"numberfield",fieldLabel:"Total ",id:"txtTotal",name:"total",decimalPrecision:3,minValue:0,step:0.01,decimalSeparator:".",readOnly:true,fieldStyle:"text-align: right;"}]}]},{xtype:"panel",border:false,frame:false,buttons:[{xytpe:"button",text:"Cancelar",scale:"medium",iconCls:"boton-cancel ",handler:function(){a=0;c.close()}},"-",{xytpe:"button",text:"Guardar",scale:"medium",iconCls:"boton-save ",handler:function(){c.ActualizarCompra();c.close()}}]}]}]});c.callParent(arguments)},getCalcularContrato:function(){var b=Ext.getCmp("dgvDetalleCompra").getStore();var e=Ext.getCmp("cboTipoDoc").getValue();var c=0;var f=0;var a=0;b.each(function(g){a=a+g.get("total")},this);if(e=="F"){c=a+(a*0.18);f=(a*0.18)}else{c=a}Ext.getCmp("txtSubtotal").setValue(a.toFixed(3));Ext.getCmp("txtIgv").setValue(f.toFixed(3));var d=(c+f);Ext.getCmp("txtTotal").setValue(d.toFixed(3))},getLimpiarPanel:function(){Ext.getCmp("txtPreciocompra").setValue("");Ext.getCmp("txtCantidad").setValue("1");Ext.getCmp("txtCodigoBobina").setValue("");Ext.getCmp("txtMetroLineal").setValue("")},getCamposVaciosPanel:function(){var a=false;if(Ext.getCmp("cboProducto").getValue()==null){a=true}if(Ext.getCmp("txtPrecioventa").getValue()==0||Ext.getCmp("txtPrecioventa").getValue()==null){a=true}if(Ext.getCmp("txtCantidad").getValue()==0||Ext.getCmp("txtCantidad").getValue()==null){a=true}if(Ext.getCmp("txtAncho").getValue()==0||Ext.getCmp("txtAncho").getValue()==null){a=true}if(Ext.getCmp("txtLargo").getValue()==0||Ext.getCmp("txtLargo").getValue()==null){a=true}return a},ActualizarCompra:function(){me=this;var a=0;Ext.Ajax.request({url:"compras/actualizar",params:{pid:0,pidprov:Ext.getCmp("cboProveedor").getValue(),pfcompra:Ext.getCmp("dfCompra").getValue(),pnumerodoc:Ext.getCmp("txtNumeroDocumento").getValue(),pvalorcompra:Ext.getCmp("txtSubtotal").getValue(),pvalorigv:Ext.getCmp("txtIgv").getValue(),pvalortotal:Ext.getCmp("txtTotal").getValue(),ptipodoc:Ext.getCmp("cboTipoDoc").getValue(),pusuario:"EERAZO"},success:function(f,c,d,e){var b=MyDesktop.app.util.Util.decodeJSON(f.responseText);if(b.success){Ext.each(b.items,function(g){if(g.ERROR<0){Ext.Msg.alert("Error","Error en Sistema ! Comunicarse con Sistemas");return false}me.ActualizarCompraDetalle(g.ERROR,storedetallecompra)})}else{MyDesktop.app.util.Util.showErrorMsg(f.responseText);return false}},failure:function(e,b,c,d){}})},setInsertarItem:function(c){var b=Ext.getCmp("cboProducto").getValue();var g=Ext.getCmp("cboProducto").getStore().find("id",b);var a=Ext.getCmp("cboProducto").getStore().getAt(g).get("descrip");var d=Ext.getCmp("txtCantidad").getValue();var f=Ext.getCmp("txtPreciocompra").getValue();var h=Ext.getCmp("txtCodigoBobina").getValue();var e=Ext.getCmp("txtMetroLineal").getValue();ix=ix+1;c.add({id:ix,idprod:parseInt(b),producto:a,precio:f,cantidad:d,total:(f*d),codbobina:(h.length==0?"0":h),mlineal:e});this.getLimpiarPanel();this.getCalcularContrato()},ActualizarCompraDetalle:function(b,e){me=this;var d="";var g="";var a="";var c="";var f="";var h="";e.each(function(j){d=d+","+j.get("idprod").toString();g=g+","+j.get("cantidad").toString();a=a+","+j.get("precio").toString();c=c+","+j.get("codbobina").toString();f=f+","+j.get("total").toString();try{h=h+","+j.get("mlineal").toString()}catch(i){h=h+","+j.get("mlineal")}});d="{"+d.substring(1,d.length)+"}";g="{"+g.substring(1,g.length)+"}";a="{"+a.substring(1,a.length)+"}";c="{"+c.substring(1,c.length)+"}";f="{"+f.substring(1,f.length)+"}";h="{"+h.substring(1,h.length)+"}";me.fx_ContratoGuardarDetalle(b,d,g,a,c,f,h)},fx_ContratoGuardarDetalle:function(b,d,f,a,c,e,g){Ext.Ajax.request({url:"compras/actualizardetalle",params:{pidcompra:b,pproductos:d,pcantidades:f,pcodbobinas:c,pprecios:a,pmlineales:g},success:function(l,i,j,k){var h=MyDesktop.app.util.Util.decodeJSON(l.responseText);if(h.success){Ext.each(h.items,function(m){if(m.ERROR>0){Ext.getCmp("dgvCompras").getStore().reload();Ext.getCmp("btnActualizarListaCompra").fireEvent("click")}})}else{MyDesktop.app.util.Util.showErrorMsg(l.responseText);return false}},failure:function(k,h,i,j){}})}});