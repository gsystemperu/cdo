var permisos=new Array();Ext.define("MyDesktop.app.views.Permisos",{extend:"Ext.panel.Panel",alias:"widget.wpermisos",require:["MyDesktop.app.stores.Usuarios"],id:"wpermisos",initComponent:function(){me=this;storePerfiles=Ext.create("MyDesktop.app.stores.Perfiles");Ext.apply(me,{layout:{align:"stretch",type:"hbox"},items:[{xtype:"panel",flex:1,layout:{align:"stretch",type:"fit"},border:false,items:[{xtype:"panel",flex:2,layout:"fit",border:false,items:[{xtype:"treepanel",id:"treeProgramas",store:Ext.create("Ext.data.TreeStore",{root:{text:"ERP Yupana",iconCls:"ux-start-button-icon",expanded:true,children:[{text:"SVentas",id:"SVentas",expanded:true,iconCls:"app",children:[{text:"Productos",id:"Productos",leaf:true,checked:false},{text:"Trabajadores",id:"Trabajadores",leaf:true,checked:false},{text:"Materiales",id:"Materiales",leaf:true,checked:false},{text:"Proveedores",id:"Proveedores",leaf:true,checked:false},{text:"Clientes",id:"Clientes",leaf:true,checked:false},{text:"Ventas Registrar",id:"Ventas Registrar",leaf:true,checked:false},{text:"Ventas Consultar",id:"Ventas Consultar",leaf:true,checked:false},{text:"Compras Registrar",id:"Compras Registrar",leaf:true,checked:false},{text:"Stock",id:"Stock",leaf:true,checked:false}]},{text:"SContabilidad",id:"SContabilidad",expanded:true,iconCls:"app",children:[{text:"Empresas",id:"Empresas",leaf:true,checked:false},{text:"Plan Contable",id:"Plan Contable",leaf:true,checked:false},{text:"Libro Diario",id:"Libro Diario",leaf:true,checked:false}]}]}}),rootVisible:true}]}]},{xtype:"panel",frame:false,flex:0.8,layout:{type:"fit"},border:false,items:[{xtype:"form",bodyPadding:10,padding:"10 5 5 5",layout:{type:"vbox",align:"stretch"},defaults:{labelWidth:150},id:"frmUsuarioPermisos",items:[{xtype:"combo",fieldLabel:"<b>Tipo de Nivel</b>",id:"cboTipoNivel",store:storePerfiles,displayField:"_descripcion",valueField:"_id_perfil",editable:false,queryMode:"remote",emptyText:"-- Seleccionar el Perfil --",listeners:{change:function(){Ext.Ajax.request({url:"usuarios/listarpermisosporperfil",params:{vIdPerfil:this.getValue()},success:function(g,d,e,f){var c=MyDesktop.app.util.Util.decodeJSON(g.responseText);permisos=[];if(c.success){Ext.each(c.items,function(h){if(h._permiso!=null){permisos.push(h._menu)}});var b=Ext.getCmp("treeProgramas");var a=b.getStore();root=b.getRootNode();root.findChildBy(function(l){var j=l.data.text;var k=a.getNodeById(j);var h=k.childNodes;Ext.each(h,function(n,m){var n=a.getNodeById(n.internalId);if(permisos.indexOf(n.internalId)>=0){n.set("checked",true)}else{n.set("checked",false)}b.fireEvent("checkchange",n,n.get("checked"))})})}else{MyDesktop.app.util.Util.showErrorMsg(g.responseText);return false}},failure:function(d,a,b,c){}})}}},{xtype:"fieldset",columnWidth:0.5,bodyPadding:"5 5 5 5",padding:"5 5 5 5",title:"Ingresar Nuevo Perfil",collapsible:false,defaultType:"textfield",defaults:{anchor:"100%"},layout:"anchor",items:[{fieldLabel:"Descripcion",name:"_descripcion",id:"_descripcion"},{xtype:"button",text:"Agregar",iconCls:"boton-save",width:100,handler:function(){Ext.getCmp("wpermisos").setAgregarNuevoPerfil(0,Ext.getCmp("_descripcion").getValue(),storePerfiles)}}]}]}],bbar:["->",{xtype:"button",text:"<b>Actualizar Permisos al Perfil</b>",iconCls:"boton-save",handler:function(){me=Ext.getCmp("wpermisos");var b=Ext.getCmp("treeProgramas");var a=b.getStore();root=b.getRootNode();enviar=new Array();root.findChildBy(function(f){var d=f.data.text;var e=a.getNodeById(d);var c=e.childNodes;Ext.each(c,function(h,g){var h=a.getNodeById(h.internalId);if(h.data.checked==true){enviar.push(h.internalId)}})});if(Ext.getCmp("cboTipoNivel").getValue()!=null){me.setCrearArraydePermisos(enviar,Ext.getCmp("cboTipoNivel").getValue())}else{Ext.Msg.alert("Error","Tiene que seleccionar un perfil de usuario!")}}}]}]});this.callParent(arguments)},setCrearArraydePermisos:function(b,a){var c="";for(i=0;i<b.length;++i){c=c+","+b[i]}c="{"+c.substring(1,c.length)+"}";console.log(c);Ext.Ajax.request({url:"usuarios/actualizarpermisosaperfil",params:{vIdPerfil:a,vPermisos:c},success:function(h,e,f,g){var d=MyDesktop.app.util.Util.decodeJSON(h.responseText);if(d.success){Ext.each(d.items,function(j){if(j.ERROR>0){Ext.Msg.alert("Permisos","Se han actualizado los permisos del perfil de usuario!!")}})}}})},setAgregarNuevoPerfil:function(a,c,b){Ext.Ajax.request({url:"usuarios/agregarperfil",params:{vId:a,vDescripcion:c},success:function(h,e,f,g){var d=MyDesktop.app.util.Util.decodeJSON(h.responseText);if(d.success){Ext.each(d.items,function(j){if(j.ERROR>0){b.reload();Ext.getCmp("_descripcion").setValue("")}})}}})}});