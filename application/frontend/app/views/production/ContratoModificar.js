Ext.define("MyDesktop.app.views.ContratoModificar",{extend:"Ext.window.Window",alias:"widget.contratomodificar",width:550,height:700,modal:true,title:"Modificar Contrato",requires:["MyDesktop.app.stores.Productos","MyDesktop.app.stores.Trabajadores"],id:"contratomodificar",initComponent:function(){me=this;storeproductos=Ext.create("MyDesktop.app.stores.Productos");storedisenio=Ext.create("MyDesktop.app.stores.Trabajadores");storevendedor=Ext.create("MyDesktop.app.stores.TrabajadoresTipo");storetiendas=Ext.create("MyDesktop.app.stores.Tiendas");storedetallecontrato=Ext.create("MyDesktop.app.stores.DetalleContrato");storemateriales=Ext.create("MyDesktop.app.stores.Materiales");Ext.applyIf(me,{items:[{xtype:"panel",flex:1,frame:true,border:false,tbar:[{xtype:"splitbutton",showText:true,text:"Insertar",menu:{xtype:"menu",items:[{xtype:"menuitem",text:"Dise\xf1ador",iconCls:"add"},{xtype:"menuitem",text:"Producto",iconCls:"add"}]}},"-",{xtype:"combobox",labelWidth:40,fieldLabel:"<b>Tienda</b>",id:"cboTienda",width:430,store:storetiendas,query:"local",displayField:"direc",valueField:"id",forceSelection:true,editable:false,value:1,emptyText:"----- Seleccionar Tienda ------"}],items:[{xtype:"fieldset",title:"Datos del Cliente",defaultType:"textfield",layout:"fit",items:[{xtype:"container",layout:"hbox",margin:"0 0 5 6",items:[{xtype:"hiddenfield",id:"txtIdContrato"},{xtype:"textfield",fieldLabel:"Cliente",name:"cliente",id:"txtDatosCliente",flex:3,fieldStyle:"text-transform:uppercase",labelWidth:61},{xtype:"button",iconCls:"x-ico-lupa"}]},{xtype:"container",layout:"hbox",anchor:"100%",items:[{xtype:"combobox",fieldLabel:"Dise\xf1ador",name:"diseniador",id:"cboDise",margin:"0 0 5 6",store:storedisenio,query:"remote",valueField:"id",displayField:"ncompleto",editable:false,labelWidth:60,emptyText:"--- Dise\xf1ador ---",width:245},{xtype:"combobox",fieldLabel:"Vendedora",name:"vendedora",id:"cboVendedora",margin:"0 0 5 6",store:storevendedor,query:"remote",valueField:"id",displayField:"ncompleto",editable:false,emptyText:"--- Vendedora ---",labelWidth:60,width:250}]}]},{xtype:"fieldset",columnWidth:0.1,title:"Fechas ",defaultType:"textfield",items:[{xtype:"container",layout:"hbox",columnWidth:0.5,margin:"0 0 5 6",items:[{xtype:"datefield",anchor:"50%",fieldLabel:"Entrega",name:"dfEntrega",id:"dfEntrega",labelWidth:60},{xtype:"datefield",anchor:"50%",fieldLabel:"Termina",name:"dfTermina",id:"dfTermina",labelWidth:60}]}]},{xtype:"fieldset",columnWidth:0.1,title:"Detalle",defaultType:"textfield",items:[{xtype:"container",layout:"fit",frame:true,border:false,items:[{xtype:"container",layout:"vbox",columnWidth:0.5,margin:"0 0 10 6",items:[{xtype:"combobox",fieldLabel:"Producto/Servicio",id:"cboProducto",store:storeproductos,query:"local",valueField:"id",displayField:"producto",flex:1,width:475,editable:false,forceSelection:true,emptyText:"  Seleccionar el Producto  ",listeners:{select:function(c,a,b){Ext.getCmp("txtPrecioventa").setValue("");Ext.getCmp("txtCantidad").setValue("");Ext.getCmp("txtAncho").setValue("");Ext.getCmp("txtLargo").setValue("")}}},{xtype:"combobox",fieldLabel:"Material",id:"cboMaterial",store:storemateriales,query:"local",valueField:"id",displayField:"descrip",flex:1,width:475,editable:false,forceSelection:true,emptyText:"  Seleccionar el Material  ",listeners:{select:function(c,a,b){Ext.getCmp("txtPrecioventa").focus(false,200)}}},{xtype:"container",layout:"hbox",columnWidth:0.5,items:[{xtype:"numberfield",id:"txtPrecioventa",mane:"precioventa",fieldLabel:"Precio Venta",fieldStyle:"text-align:right",decimalPrecision:2,step:0.01,decimalSeparator:".",currencySymbol:"S/. "},{xtype:"numberfield",fieldLabel:"Cantidad",id:"txtCantidad",fieldStyle:"text-align:center;size:15px",maxValue:50,minValue:0,flex:0.5}]},{xtype:"fieldset",padding:"0 5 5 5",layout:"hbox",title:"Medidas en metros ",columnWidth:1,items:[{xtype:"numberfield",fieldLabel:"Ancho ",labelWidth:50,id:"txtAncho",width:130,fieldStyle:"text-align:right",decimalPrecision:2,step:0.01,decimalSeparator:"."},{xtype:"numberfield",fieldLabel:"Largo ",id:"txtLargo",labelWidth:50,width:130,fieldStyle:"text-align:right",decimalPrecision:2,step:0.01,decimalSeparator:"."}]}]}]},{xtype:"panel",layout:"fit",margin:"0 0 5 0",items:[{xtype:"grid",flex:1,id:"dgvDetalleContrato",store:storedetallecontrato,columns:[{text:"Id",dataIndex:"id",align:"center",width:25,hidden:true},{text:"Producto",dataIndex:"producto",width:230},{text:"Ancho",dataIndex:"medida1",width:50,align:"center"},{text:"Largo",dataIndex:"medida2",width:50,align:"center"},{text:"Cantidad",dataIndex:"cantidad",width:55,align:"center"},{text:"Total",dataIndex:"total",align:"right",width:60},{xtype:"actioncolumn",width:40,align:"center",items:[{iconCls:"remove",handler:function(e,f,d){var b=e.getStore().getAt(f);var a=b.get("id");var c=Ext.getCmp("dgvDetalleContrato").getStore();c.remove(c.findRecord("id",a));me.getCalcularContrato()}}]}],height:150,listeners:{itemdblclick:function(d,b,f,c,g){var a=b.get("idprod");Ext.getCmp("cboProducto").setValue(a.toString());Ext.getCmp("txtPrecioventa").setValue(b.get("total")/b.get("cantidad"));Ext.getCmp("txtCantidad").setValue(b.get("cantidad"));Ext.getCmp("txtAncho").setValue(b.get("medida1"));Ext.getCmp("txtLargo").setValue(b.get("medida2"));Ext.getCmp("cboMaterial").setValue(b.get("idmat"))}}}],tbar:[{xtype:"button",text:"Ingresar",id:"btnIngresar",iconCls:"add",handler:function(){me.setInsertarItem()}},{xtype:"button",text:"Modificar",id:"btnModificar",iconCls:"boton-edit",handler:function(){var a=Ext.getCmp("dgvDetalleContrato");var g=a.getSelectionModel().getSelection()[0].get("id");var h=Ext.getCmp("dgvDetalleContrato").getStore();var e=h.findRecord("id",g);if(e){var b=Ext.getCmp("txtPrecioventa").getValue();var i=Ext.getCmp("txtCantidad").getValue();var c=Ext.getCmp("txtAncho").getValue();var d=Ext.getCmp("txtLargo").getValue();var f=b*i;e.set("medida1",c);e.set("medida2",d);e.set("cantidad",i);e.set("total",f);e.endEdit();e.commit();me.getCalcularContrato()}}}]}]},{xtype:"panel",border:false,frame:true,layout:"hbox",padding:5,items:[{xtype:"container",border:false,flex:1,layout:"vbox",items:[{xtype:"numberfield",fieldLabel:"Pago a Cuenta",id:"txtPagoCuenta",name:"pagocuenta",fieldStyle:"text-align: right;",decimalPrecision:2,width:200,step:0.01,decimalSeparator:".",enableKeyEvents:true,listeners:{keyup:function(a,b){if(b.keyCode==13){store=Ext.getCmp("dgvDetalleContrato").getStore();me.getCalcularContrato(store)}}}},{xtype:"numberfield",fieldLabel:"<b>Saldo</b>",id:"txtSaldoPago",name:"saldopago",fieldStyle:"text-align: right;",decimalPrecision:2,width:200,step:0.01,decimalSeparator:"."}]},{xtype:"container",border:true,flex:1,padding:"3 50 0 0",items:[{xtype:"numberfield",id:"txtSubtotal",name:"subtotal",fieldLabel:"Sub Total",decimalPrecision:3,maxValue:9999,minValue:0,step:0.01,decimalSeparator:".",readOnly:true,width:200,fieldStyle:"text-align:right"},{xtype:"numberfield",fieldLabel:"Igv",id:"txtIgv",name:"igv",decimalPrecision:3,maxValue:9999,minValue:0,step:0.01,decimalSeparator:".",readOnly:true,enableKeyEvents:true,width:200,fieldStyle:"text-align:right"},{xtype:"numberfield",fieldLabel:"Total ",id:"txtTotal",name:"total",decimalPrecision:3,maxValue:9999,minValue:0,step:0.01,decimalSeparator:".",readOnly:true,width:200,fieldStyle:"text-align: right;"}]}]},{xtype:"panel",border:false,frame:false,buttons:[{xytpe:"button",text:"Cancelar",scale:"medium",iconCls:"boton-cancel ",handler:function(){ix=0;me.close()}},"-",{xtype:"checkboxfield",boxLabel:"<b>El Precio incluye I.G.V</b>",inputValue:1,id:"ckbAplicarIgv",listeners:{change:function(a,b){store=Ext.getCmp("dgvDetalleContrato").getStore();me.getCalcularContrato(store)}}},"-",{xytpe:"button",text:"Guardar",scale:"medium",iconCls:"boton-save ",id:"btnGuardar",handler:function(){me.ActualizarContrato();me.close()}}]}]}]});me.callParent(arguments)},setCargarDatosDeProforma:function(a){Ext.Ajax.request({url:"contratos/buscarcontratocab",params:{pidcontrato:a},success:function(h,d,e,f){var b=MyDesktop.app.util.Util.decodeJSON(h.responseText);var g=new Ext.LoadMask(Ext.getCmp("contratomodificar"),{msg:" Buscando la informacion..."});g.show();Ext.each(b.items,function(i){Ext.getCmp("dfEntrega").setValue(i.fechaemi);Ext.getCmp("txtDatosCliente").setValue(i.pers);Ext.getCmp("dfTermina").setValue(i.feentrega);Ext.getCmp("txtSubtotal").setValue(i.subtotal);Ext.getCmp("txtIgv").setValue(i.igv);Ext.getCmp("txtPagoCuenta").setValue(i.pagocuenta);Ext.getCmp("cboVendedora").setValue(i.perven);Ext.getCmp("cboDise").setValue(i.perdise);Ext.getCmp("cboTienda").setValue(i.tienda);Ext.getCmp("txtTotal").setValue(i.total);Ext.getCmp("txtIdContrato").setValue(i.id);if(parseFloat(i.igv)!=0){Ext.getCmp("ckbAplicarIgv").setRawValue(true)}else{Ext.getCmp("ckbAplicarIgv").setRawValue(false)}console.log(Ext.getCmp("txtPagoCuenta").getValue());if(Ext.getCmp("txtPagoCuenta").getValue()!=null){Ext.getCmp("txtSaldoPago").setValue(Ext.getCmp("txtTotal").getValue()-Ext.getCmp("txtPagoCuenta").getValue())}else{Ext.getCmp("txtSaldoPago").setValue("")}});var c=Ext.getCmp("dgvDetalleContrato").getStore();Ext.Ajax.request({url:"contratos/buscarcontratodet",params:{pidcontrato:a},success:function(m,j,k,l){var i=MyDesktop.app.util.Util.decodeJSON(m.responseText);Ext.each(i.items,function(n){c.add({id:ix,idprod:parseInt(n.idpro),producto:n.producto,medida1:n.medida1,medida2:n.medida2,cantidad:n.cant,total:n.total,idmat:n.idmate});ix++});c.sync()}});g.destroy()}})},setInsertarItem:function(){var g=Ext.getCmp("dgvDetalleContrato").getStore();var b=Ext.getCmp("cboProducto").getValue();var a=Ext.getCmp("cboProducto").getStore().find("id",b);var j=Ext.getCmp("cboProducto").getStore().getAt(a).get("producto");var c=Ext.getCmp("txtPrecioventa").getValue();var d=Ext.getCmp("txtCantidad").getValue();var i=Ext.getCmp("txtAncho").getValue();var h=Ext.getCmp("txtLargo").getValue();var f=c*d;var e=Ext.getCmp("cboMaterial").getValue();ix=ix+1;g.add({id:ix,idprod:parseInt(b),producto:j,medida1:i,medida2:h,cantidad:d,total:f,idmat:e});this.getCalcularContrato();Ext.getCmp("txtPrecioventa").focus("",200)},getCalcularContrato:function(){var b=Ext.getCmp("dgvDetalleContrato").getStore();var d=Ext.getCmp("ckbAplicarIgv").getValue();var c=0;var e=0;var a=0;console.log(b);b.each(function(f){a=a+parseFloat(f.get("total"))},this);if(d==true){c=a+(a*0.18);e=(a*0.18)}else{c=a}Ext.getCmp("txtSubtotal").setValue(a);Ext.getCmp("txtIgv").setValue(e);Ext.getCmp("txtTotal").setValue((c+e));if(Ext.getCmp("txtPagoCuenta").getValue()!=0){Ext.getCmp("txtSaldoPago").setValue(Ext.getCmp("txtTotal").getValue()-Ext.getCmp("txtPagoCuenta").getValue())}else{Ext.getCmp("txtSaldoPago").setValue("")}},ActualizarContrato:function(){var a=0;var b=Ext.getCmp("dgvDetalleContrato").getStore();Ext.Ajax.request({url:"contratos/actualizar",params:{pid:Ext.getCmp("txtIdContrato").getValue(),pfcontrato:Ext.getCmp("dfEntrega").getValue(),ppersona:Ext.getCmp("txtDatosCliente").getValue(),pfentrega:Ext.getCmp("dfEntrega").getValue(),psubtotal:Ext.getCmp("txtSubtotal").getValue(),pigvtot:Ext.getCmp("txtIgv").getValue(),ptotal:Ext.getCmp("txtTotal").getValue(),pacuenta:Ext.getCmp("txtPagoCuenta").getValue(),piddise:Ext.getCmp("cboDise").getValue(),pidvende:Ext.getCmp("cboVendedora").getValue(),pidtienda:Ext.getCmp("cboTienda").getValue(),pusuario:"EERAZO"},success:function(g,d,e,f){var c=MyDesktop.app.util.Util.decodeJSON(g.responseText);if(c.success){Ext.each(c.items,function(h){if(h.ERROR<0){Ext.Msg.alert("Error","Error en Sistema ! Comunicarse con Sistemas");return false}ActualizarContratoDetalle(h.ERROR,b)})}else{MyDesktop.app.util.Util.showErrorMsg(g.responseText);return false}},failure:function(f,c,d,e){}})}});function ActualizarContratoDetalle(f,i){var g=i;var a="";var c="";var e="";var d="";var h="";var b="";g.each(function(j){a=a+","+j.get("idprod").toString();c=c+","+j.get("cantidad").toString();e=e+","+j.get("medida1").toString();d=d+","+j.get("medida2").toString();h=h+","+j.get("total").toString();b=b+","+j.get("idmat").toString()});a="{"+a.substring(1,a.length)+"}";c="{"+c.substring(1,c.length)+"}";e="{"+e.substring(1,e.length)+"}";d="{"+d.substring(1,d.length)+"}";h="{"+h.substring(1,h.length)+"}";b="{"+b.substring(1,b.length)+"}";fx_ContratoGuardarDetalle(f,a,c,e,d,h,b)}function fx_ContratoGuardarDetalle(e,a,b,d,c,f,g){Ext.Ajax.request({url:"contratos/actualizardetalle",params:{pid:e,pcontrato:e,pproductos:a,pcantidades:b,pmedidas1:d,pmedidas2:c,pprecios:f,pmateriales:g},success:function(l,i,j,k){var h=MyDesktop.app.util.Util.decodeJSON(l.responseText);if(h.success){Ext.each(h.items,function(m){if(m.ERROR>0){}Ext.getCmp("dgvContratos").getStore().reload()})}else{MyDesktop.app.util.Util.showErrorMsg(l.responseText);return false}},failure:function(k,h,i,j){}})};