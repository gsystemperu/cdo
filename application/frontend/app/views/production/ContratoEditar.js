ix=0;ult_id=0;Ext.define("MyDesktop.app.views.ContratoEditar",{extend:"Ext.window.Window",alias:"widget.wcontratoeditar",id:"wcontratoeditar",width:750,height:710,modal:true,floating:true,autoShow:true,title:"::: - Registro de Contratos - :::",bodyPadding:5,requires:["MyDesktop.app.stores.Productos","MyDesktop.app.stores.Trabajadores"],initComponent:function(){var a=0;var b=0;var c=this;storeproductos=Ext.create("MyDesktop.app.stores.Productos");storedisenio=Ext.create("MyDesktop.app.stores.Trabajadores");storevendedor=Ext.create("MyDesktop.app.stores.TrabajadoresTipo");storetiendas=Ext.create("MyDesktop.app.stores.Tiendas");storedetallecontrato=Ext.create("MyDesktop.app.stores.DetalleContrato");storemateriales=Ext.create("MyDesktop.app.stores.Materiales");Ext.applyIf(c,{items:[{xtype:"panel",flex:1,frame:true,border:false,tbar:[{xtype:"splitbutton",showText:true,text:"Insertar",menu:{xtype:"menu",items:[{xtype:"menuitem",text:"Dise\xf1ador",iconCls:"add"},{xtype:"menuitem",text:"Producto",iconCls:"add"}]}},"-",{xtype:"combobox",labelWidth:40,fieldLabel:"<b>Tienda</b>",id:"cboTienda",width:"90%",store:storetiendas,query:"remote",displayField:"direc",valueField:"id",forceSelection:true,editable:false,emptyText:"----- Seleccionar Tienda ------"}],items:[{xtype:"fieldset",title:"Datos del Cliente",defaultType:"textfield",layout:"fit",items:[{xtype:"container",layout:"hbox",margin:"0 0 5 6",items:[{xtype:"textfield",fieldLabel:"Cliente",name:"cliente",id:"txtDatosCliente",flex:3,fieldStyle:"text-transform:uppercase"}]},{xtype:"container",layout:"hbox",items:[{xtype:"combobox",fieldLabel:"Dise\xf1ador",name:"diseniador",id:"cboDise",margin:"0 0 5 6",store:storedisenio,query:"remote",valueField:"id",displayField:"ncompleto",editable:false,emptyText:"--- Dise\xf1ador ---",width:350},{xtype:"combobox",fieldLabel:"Vendedora",name:"vendedora",id:"cboVendedora",margin:"0 0 5 6",store:storevendedor,query:"remote",valueField:"id",displayField:"ncompleto",editable:false,emptyText:"--- Vendedora ---",width:340}]}]},{xtype:"fieldset",columnWidth:0.1,title:"Fechas ",defaultType:"textfield",items:[{xtype:"container",layout:"hbox",columnWidth:0.5,margin:"0 0 5 6",items:[{xtype:"datefield",width:200,fieldLabel:"Entrega",name:"dfEntrega",id:"dfEntrega",minValue:new Date(),value:new Date()},{xtype:"datefield",width:200,fieldLabel:"Termina",name:"dfTermina",id:"dfTermina",minValue:new Date(),value:new Date()}]}]},{xtype:"fieldset",columnWidth:0.1,title:"Detalle",defaultType:"textfield",items:[{xtype:"container",layout:"fit",frame:true,border:false,items:[{xtype:"container",layout:"vbox",columnWidth:0.5,margin:"0 0 10 6",items:[{xtype:"combobox",fieldLabel:"Producto",id:"cboProducto",store:storeproductos,query:"local",valueField:"id",displayField:"producto",flex:1,width:675,editable:false,forceSelection:true,emptyText:"  Seleccionar el Producto  ",listeners:{select:function(f,d,e){Ext.getCmp("txtPrecioventa").setValue("");Ext.getCmp("txtCantidad").setValue("");Ext.getCmp("txtAncho").setValue("");Ext.getCmp("txtLargo").setValue("")}}},{xtype:"combobox",fieldLabel:"Material",id:"cboMaterial",store:storemateriales,query:"local",valueField:"id",displayField:"descrip",flex:1,width:675,editable:false,forceSelection:true,emptyText:"  Seleccionar el Material  ",listeners:{select:function(f,d,e){Ext.getCmp("txtPrecioventa").focus(false,200)}}},{xtype:"container",layout:"hbox",columnWidth:0.5,items:[{xtype:"numberfield",id:"txtPrecioventa",mane:"precioventa",fieldLabel:"Precio Venta",fieldStyle:"text-align:right",decimalPrecision:2,step:0.01,decimalSeparator:".",currencySymbol:"S/. "},{xtype:"numberfield",fieldLabel:"Cantidad",id:"txtCantidad",fieldStyle:"text-align:center;size:15px",maxValue:50,minValue:0,flex:0.5}]},{xtype:"fieldset",padding:"0 5 5 5",layout:"hbox",title:"Medidas en metros ",columnWidth:1,items:[{xtype:"numberfield",fieldLabel:"Ancho ",labelWidth:50,id:"txtAncho",width:130,fieldStyle:"text-align:right",decimalPrecision:2,step:0.01,decimalSeparator:"."},{xtype:"numberfield",fieldLabel:"Largo ",id:"txtLargo",labelWidth:50,width:130,fieldStyle:"text-align:right",decimalPrecision:2,step:0.01,decimalSeparator:"."}]}]}]},{xtype:"panel",layout:"fit",margin:"0 0 5 0",items:[{xtype:"grid",flex:1,id:"dgvDetalleContrato",store:storedetallecontrato,columns:[{text:"Id",dataIndex:"id",align:"center",width:25,hidden:true},{text:"Producto",dataIndex:"producto",width:400},{text:"Ancho",dataIndex:"medida1",width:50,align:"center"},{text:"Largo",dataIndex:"medida2",width:50,align:"center"},{text:"Cantidad",dataIndex:"cantidad",width:55,align:"center"},{text:"Total",dataIndex:"total",align:"right",width:80},{xtype:"actioncolumn",width:40,align:"center",items:[{iconCls:"remove",handler:function(h,i,g){var e=h.getStore().getAt(i);var d=e.get("id");var f=Ext.getCmp("dgvDetalleContrato").getStore();f.remove(f.findRecord("id",d));c.getCalcularContrato()}}]}],height:150,listeners:{itemdblclick:function(h,f,i,g,j){var d=f.get("idprod");Ext.getCmp("cboProducto").setValue(d.toString());Ext.getCmp("txtPrecioventa").setValue(f.get("total")/f.get("cantidad"));Ext.getCmp("txtCantidad").setValue(f.get("cantidad"));Ext.getCmp("txtAncho").setValue(f.get("medida1"));Ext.getCmp("txtLargo").setValue(f.get("medida2"))}}}],tbar:[{xtype:"button",text:"Ingresar",id:"btnIngresar",iconCls:"add",handler:function(){c.setInsertarItem(storedetallecontrato)}},{xtype:"button",text:"Modificar",id:"btnModificar",iconCls:"boton-edit",handler:function(){var d=Ext.getCmp("dgvDetalleContrato");var j=d.getSelectionModel().getSelection()[0].get("id");var k=Ext.getCmp("dgvDetalleContrato").getStore();var h=k.findRecord("id",j);if(h){var e=Ext.getCmp("txtPrecioventa").getValue();var l=Ext.getCmp("txtCantidad").getValue();var f=Ext.getCmp("txtAncho").getValue();var g=Ext.getCmp("txtLargo").getValue();var i=e*l;h.set("medida1",f);h.set("medida2",g);h.set("cantidad",l);h.set("total",i);h.endEdit();h.commit();c.getCalcularContrato()}}}]}]},{xtype:"panel",border:false,frame:true,layout:"hbox",padding:5,items:[{xtype:"container",border:false,flex:1,layout:"vbox",items:[{xtype:"numberfield",fieldLabel:"Pago a Cuenta",id:"txtPagoCuenta",name:"pagocuenta",fieldStyle:"text-align: right;",decimalPrecision:2,width:200,step:0.01,decimalSeparator:".",enableKeyEvents:true,listeners:{keyup:function(d,f){if(f.keyCode==13){store=Ext.getCmp("dgvDetalleContrato").getStore();c.getCalcularContrato(store)}}}},{xtype:"numberfield",fieldLabel:"<b>Saldo</b>",id:"txtSaldoPago",name:"saldopago",fieldStyle:"text-align: right;",decimalPrecision:2,width:200,step:0.01,decimalSeparator:"."}]},{xtype:"panel",border:true,flex:1,frame:true,items:[{xtype:"numberfield",id:"txtSubtotal",name:"subtotal",fieldLabel:"Sub Total",decimalPrecision:3,maxValue:9999,minValue:0,step:0.01,decimalSeparator:".",readOnly:true,width:280,labelWidth:120,fieldStyle:"text-align: right;"},{xtype:"numberfield",fieldLabel:"Igv",id:"txtIgv",name:"igv",fieldStyle:"text-align: right;",decimalPrecision:3,maxValue:9999,minValue:0,step:0.01,decimalSeparator:".",readOnly:true,enableKeyEvents:true,width:280,labelWidth:120},{xtype:"numberfield",fieldLabel:"Total ",id:"txtTotal",name:"total",decimalPrecision:3,maxValue:9999,minValue:0,step:0.01,decimalSeparator:".",readOnly:true,width:280,labelWidth:120,fieldStyle:"text-align: right;"}]}]},{xtype:"panel",border:false,frame:false,buttons:[{xytpe:"button",text:"Cancelar",scale:"medium",iconCls:"boton-cancel ",handler:function(){a=0;c.close()}},"-",{xtype:"checkboxfield",boxLabel:"<b>El Precio incluye I.G.V</b>",inputValue:1,id:"ckbAplicarIgv",listeners:{change:function(d,e){store=Ext.getCmp("dgvDetalleContrato").getStore();c.getCalcularContrato(store)}}},"-",{xytpe:"button",text:"Guardar",scale:"medium",iconCls:"boton-save ",handler:function(){c.ActualizarContrato();c.close()}}]}]}]});c.callParent(arguments)},getCalcularContrato:function(){var b=Ext.getCmp("dgvDetalleContrato").getStore();var d=Ext.getCmp("ckbAplicarIgv").getValue();var c=0;var e=0;var a=0;b.each(function(f){a=a+f.get("total")},this);if(d==true){c=a+(a*0.18);e=(a*0.18)}else{c=a}Ext.getCmp("txtSubtotal").setValue(a);Ext.getCmp("txtIgv").setValue(e);Ext.getCmp("txtTotal").setValue((c+e));if(Ext.getCmp("txtPagoCuenta").getValue()!=""){Ext.getCmp("txtSaldoPago").setValue(Ext.getCmp("txtTotal").getValue()-Ext.getCmp("txtPagoCuenta").getValue())}else{Ext.getCmp("txtSaldoPago").setValue("")}},getLimpiarPanel:function(){Ext.getCmp("txtPrecioventa").setValue("");Ext.getCmp("txtCantidad").setValue("");Ext.getCmp("txtAncho").setValue("");Ext.getCmp("txtLargo").setValue("")},getCamposVaciosPanel:function(){var a=false;if(Ext.getCmp("cboProducto").getValue()==null){a=true}if(Ext.getCmp("txtPrecioventa").getValue()==0||Ext.getCmp("txtPrecioventa").getValue()==null){a=true}if(Ext.getCmp("txtCantidad").getValue()==0||Ext.getCmp("txtCantidad").getValue()==null){a=true}if(Ext.getCmp("txtAncho").getValue()==0||Ext.getCmp("txtAncho").getValue()==null){a=true}if(Ext.getCmp("txtLargo").getValue()==0||Ext.getCmp("txtLargo").getValue()==null){a=true}return a},ActualizarContrato:function(){var a=0;Ext.Ajax.request({url:"contratos/actualizar",params:{pid:0,pfcontrato:Ext.getCmp("dfEntrega").getValue(),ppersona:Ext.getCmp("txtDatosCliente").getValue(),pfentrega:Ext.getCmp("dfEntrega").getValue(),psubtotal:Ext.getCmp("txtSubtotal").getValue(),pigvtot:Ext.getCmp("txtIgv").getValue(),ptotal:Ext.getCmp("txtTotal").getValue(),pacuenta:Ext.getCmp("txtPagoCuenta").getValue(),piddise:Ext.getCmp("cboDise").getValue(),pidvende:Ext.getCmp("cboVendedora").getValue(),pidtienda:Ext.getCmp("cboTienda").getValue(),pusuario:"EERAZO"},success:function(f,c,d,e){var b=MyDesktop.app.util.Util.decodeJSON(f.responseText);if(b.success){Ext.each(b.items,function(g){if(g.ERROR<0){Ext.Msg.alert("Error","Error en Sistema ! Comunicarse con Sistemas");return false}ActualizarContratoDetalle(g.ERROR,storedetallecontrato);Ext.getCmp("dgvContratos").getStore().reload()})}else{MyDesktop.app.util.Util.showErrorMsg(f.responseText);return false}},failure:function(e,b,c,d){}})},setInsertarItem:function(h){if(this.getCamposVaciosPanel()){Ext.Msg.alert("Aviso","Ingrese los campos!");return false}var d=Ext.getCmp("dgvDetalleContrato").getStore();var b=Ext.getCmp("cboProducto").getValue();var a=Ext.getCmp("cboProducto").getStore().find("id",b);var k=Ext.getCmp("cboProducto").getStore().getAt(a).get("producto");var c=Ext.getCmp("txtPrecioventa").getValue();var e=Ext.getCmp("txtCantidad").getValue();var j=Ext.getCmp("txtAncho").getValue();var i=Ext.getCmp("txtLargo").getValue();var g=c*e;var f=Ext.getCmp("cboMaterial").getValue();ix=ix+1;h.add({id:ix,idprod:parseInt(b),producto:k,medida1:j,medida2:i,cantidad:e,total:g,idmat:f});this.getLimpiarPanel();this.getCalcularContrato();Ext.getCmp("txtPrecioventa").focus("",200)}});function ActualizarContratoDetalle(f,i){var g=i;var a="";var c="";var e="";var d="";var h="";var b="";g.each(function(j){a=a+","+j.get("idprod").toString();c=c+","+j.get("cantidad").toString();e=e+","+j.get("medida1").toString();d=d+","+j.get("medida2").toString();h=h+","+j.get("total").toString();b=b+","+j.get("idmat").toString()});a="{"+a.substring(1,a.length)+"}";c="{"+c.substring(1,c.length)+"}";e="{"+e.substring(1,e.length)+"}";d="{"+d.substring(1,d.length)+"}";h="{"+h.substring(1,h.length)+"}";b="{"+b.substring(1,b.length)+"}";fx_ContratoGuardarDetalle(f,a,c,e,d,h,b)}function fx_ContratoGuardarDetalle(e,a,b,d,c,f,g){Ext.Ajax.request({url:"contratos/actualizardetalle",params:{pid:0,pcontrato:e,pproductos:a,pcantidades:b,pmedidas1:d,pmedidas2:c,pprecios:f,pmateriales:g},success:function(l,i,j,k){var h=MyDesktop.app.util.Util.decodeJSON(l.responseText);if(h.success){Ext.each(h.items,function(m){if(m.ERROR>0){}})}else{MyDesktop.app.util.Util.showErrorMsg(l.responseText);return false}},failure:function(k,h,i,j){}})};