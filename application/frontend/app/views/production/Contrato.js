Ext.define("MyDesktop.app.views.Contrato",{extend:"Ext.grid.Panel",alias:"widget.wcontrato",requires:["MyDesktop.app.views.ContratoEditar","MyDesktop.app.views.ContratoModificar","MyDesktop.app.stores.Contratos","MyDesktop.app.views.ContratoDetalle","MyDesktop.app.views.FacturaBoleta","MyDesktop.app.stores.Generos","Ext.ux.IFrame"],initComponent:function(){storecontratos=Ext.create("MyDesktop.app.stores.Contratos");storefiltros=Ext.create("MyDesktop.app.stores.BusquedasVentas");me=this;Ext.apply(me,{layout:"fit",id:"dgvContratos",sortableColumns:false,store:storecontratos,columns:[{text:"Codigo",flex:0.5,sortable:true,dataIndex:"idcontrato",align:"left"},{text:"Fecha Entrega",flex:0.5,sortable:true,dataIndex:"fechaentrega",align:"center"},{text:"Cliente",flex:1,sortable:true,dataIndex:"cliente",align:"left"},{text:"Dise\xf1ador",sortable:true,flex:1,dataIndex:"diseniador",align:"left"},{text:"Tienda",flex:1.5,sortable:true,dataIndex:"direcciontienda",align:"center"},{text:"Estado",style:"text-aling:center",flex:0.6,sortable:true,dataIndex:"estadocontra",align:"center",renderer:function(f,c,b,g,e,d,a){switch(parseInt(b.get("iestado"))){case 4:return'<b style="color: #CC0000">'+f+"</b>";case 5:return'<b style="color: #FCC612">'+f+"</b>";case 6:return'<b style="color: #006400">'+f+"</b>"}return"<b>"+f+"</b>"}},{xtype:"templatecolumn",tpl:"<b>{cantproce} de {cantreg}</b>",flex:0.4,align:"center"}],listeners:{itemclick:function(c,a,d,b,f){this.grillaBotonesEstado(a.get("iestado"))}},tbar:[{xtype:"button",text:"Nuevo",iconCls:"add",id:"btnNuevoContrato",handler:function(){var a=Ext.create("MyDesktop.app.views.ContratoEditar")}},"-",{xtype:"button",text:"Editar",iconCls:"boton-edit",id:"btnEditarContrato",handler:function(){var c=Ext.create("MyDesktop.app.views.ContratoModificar");var b=Ext.getCmp("dgvContratos");var a=b.getSelectionModel().getSelection()[0];c.setCargarDatosDeProforma(parseInt(a.get("idcontrato")));c.show()}},"-",{xtype:"button",text:"Eliminar",iconCls:"remove",id:"btnEliminarContrato",disabled:true,handler:function(){var b=Ext.getCmp("dgvContratos");var a=b.getSelectionModel().getSelection()[0];Ext.Msg.show({title:"Sistema",msg:"Desea eliminar el contrato seleccionado?",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,fn:function(e,d,c){if(e==="yes"){Ext.Ajax.request({url:"contratos/eliminarcontrato",params:{idcontra:parseInt(a.get("idcontrato"))},success:function(j,g,h,i){var f=MyDesktop.app.util.Util.decodeJSON(j.responseText);if(f.success){Ext.each(f.items,function(k){if(k.ERROR>0){Ext.getCmp("dgvContratos").getStore().reload()}})}else{MyDesktop.app.util.Util.showErrorMsg(j.responseText);return false}},failure:function(i,f,g,h){}});Ext.getCmp("dgvContratos").getStore().reload()}}})}},"-",{xtype:"button",text:"Imprimir",iconCls:"boton-print",disabled:true,id:"btnImprimirContrato",handler:function(){try{var b=Ext.getCmp("dgvContratos");var c=b.getSelectionModel().getSelection()[0].get("idcontrato")}catch(d){MyDesktop.app.util.Util.showErrorMsg("No ha selecionado un contrato registrado!");return false}var a="reportes/imprimirdocumentoventa/"+parseInt(c).toString();my=window.open(a,"mywindow","location=1,status=1,scrollbars=1,  width=800,height=400");setTimeout(function(){my.close()},1000)}},"-",{xtype:"button",iconCls:"x-ico-lupa",disabled:false,id:"btnVisualizar",handler:function(){var b=Ext.getCmp("dgvContratos");var a=b.getSelectionModel().getSelection()[0];var c=Ext.create("MyDesktop.app.views.ContratoDetalle");Ext.getCmp("btnActualizarBobina").setDisabled(true)}},"-",{xtype:"button",text:"Actualizar Lista",iconCls:"icon-grid",handler:function(){Ext.getCmp("dgvContratos").getStore().reload()}},,"-",{xtype:"button",text:"Registrar Bobinas",iconCls:"icon-grid",disabled:true,id:"btnContratoAsignarBobina",handler:function(){var b=Ext.getCmp("dgvContratos");var a=b.getSelectionModel().getSelection()[0];var c=Ext.create("MyDesktop.app.views.ContratoDetalle")}},"-",{xtype:"button",text:"Registrar Entrega",iconCls:"icon-grid",disabled:true,id:"btnContratoRegistroSalida",handler:function(){var b=Ext.getCmp("dgvContratos");var a=b.getSelectionModel().getSelection()[0];var c=Ext.create("MyDesktop.app.views.FacturaBoleta")}},"-",{xtype:"combobox",fieldLabel:"Filtrar",id:"btnComboFiltro",flex:0.5,labelWidth:35,store:storefiltros,valueField:"id",displayField:"descripcion",emptyText:"----- Seleccionar ----",query:"local",editable:false,listeners:{select:function(e,a,c){if(e.getValue()==0||e.getValue()==1){Ext.getCmp("txtBuscador").focus(true,200);Ext.getCmp("txtBuscador").setDisabled(false);Ext.getCmp("txtBuscador").setValue("")}else{Ext.getCmp("txtBuscador").focus(false,200);Ext.getCmp("txtBuscador").setDisabled(true);Ext.getCmp("txtBuscador").setValue("");var d=e.getValue();var b=Ext.getCmp("txtBuscador").getValue();me.filtrarGrillaContrato(d,b)}}}},{xtype:"textfield",id:"txtBuscador",hasfocus:true,disabled:true,flex:0.5,listeners:{specialkey:function(c,d){if(d.getKey()==d.ENTER){var b=Ext.getCmp("btnComboFiltro").getValue();var a=c.getValue();me.filtrarGrillaContrato(b,a)}}}},"-",{xtype:"label",text:"Buscar Fecha"},{xtype:"datefield",value:new Date(),id:"dpFechaContrato",flex:0.3,format:"d/m/Y",listeners:{change:function(d,c,a){var b=Ext.Date.format(d.getValue(),"d/m/Y");console.log(b);me.filtrarGrillaContrato(-2,b.toString())}}}]});this.callParent(arguments)},filtrarGrillaContrato:function(a,b){if(a==-2){storecontratos.getProxy().extraParams={pidcontrato:0,pcliente:null,pestado:0,pfecha:b};storecontratos.loadPage(1);return false}if(a==-1){storecontratos.getProxy().extraParams={pidcontrato:0,pcliente:null,pestado:0,pfecha:null}}else{storecontratos.getProxy().extraParams={pidcontrato:(a==0?b:0),pcliente:(a==1?b:null),pestado:(a>1?a:0),pfecha:null}}storecontratos.loadPage(1)},imprimirDocumentoVenta:function(){try{var b=Ext.getCmp("dgvContratos");var c=b.getSelectionModel().getSelection()[0].get("idcontrato")}catch(d){MyDesktop.app.util.Util.showErrorMsg("No ha selecionado un contrato registrado!");return false}var a="reportes/imprimirdocumentoventa/"+parseInt(c).toString();xpos=(screen.width/2)-(1000/2);ypos=(screen.height/2)-(600/2);my=window.open(a,"mywindow","location=1,status=1,scrollbars=1,  width=1000,height=600");my.moveTo(xpos,ypos);setTimeout(function(){my.close()},1000)},grillaBotonesEstado:function(a){console.log(a);switch(parseInt(a)){case 1:Ext.getCmp("btnEliminarContrato").setDisabled(false);Ext.getCmp("btnNuevoContrato").setDisabled(false);Ext.getCmp("btnEditarContrato").setDisabled(false);Ext.getCmp("btnImprimirContrato").setDisabled(true);Ext.getCmp("btnContratoAsignarBobina").setDisabled(false);Ext.getCmp("btnContratoRegistroSalida").setDisabled(true);break;case 2:Ext.getCmp("btnEliminarContrato").setDisabled(true);Ext.getCmp("btnNuevoContrato").setDisabled(false);Ext.getCmp("btnEditarContrato").setDisabled(true);Ext.getCmp("btnImprimirContrato").setDisabled(false);Ext.getCmp("btnContratoAsignarBobina").setDisabled(false);Ext.getCmp("btnContratoRegistroSalida").setDisabled(true);break;case 4:Ext.getCmp("btnEliminarContrato").setDisabled(true);Ext.getCmp("btnNuevoContrato").setDisabled(false);Ext.getCmp("btnEditarContrato").setDisabled(true);Ext.getCmp("btnImprimirContrato").setDisabled(true);Ext.getCmp("btnContratoAsignarBobina").setDisabled(false);Ext.getCmp("btnContratoRegistroSalida").setDisabled(true);break;case 5:Ext.getCmp("btnEliminarContrato").setDisabled(false);Ext.getCmp("btnNuevoContrato").setDisabled(false);Ext.getCmp("btnEditarContrato").setDisabled(false);Ext.getCmp("btnImprimirContrato").setDisabled(true);Ext.getCmp("btnContratoAsignarBobina").setDisabled(false);Ext.getCmp("btnContratoRegistroSalida").setDisabled(true);break;case 6:Ext.getCmp("btnEliminarContrato").setDisabled(false);Ext.getCmp("btnNuevoContrato").setDisabled(false);Ext.getCmp("btnEditarContrato").setDisabled(false);Ext.getCmp("btnImprimirContrato").setDisabled(false);Ext.getCmp("btnContratoAsignarBobina").setDisabled(false);Ext.getCmp("btnContratoRegistroSalida").setDisabled(false);break}}});